<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>selfie_nyc</title>
    <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=no' />
    <link rel='shortcut icon' type='image/jpg' href='assets/favicon.png'/>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
    <link rel="stylesheet" href="main.css">
</head>
<body>
<div class='header'>
    <img src='assets/logo.png' id='logo'></img>
    <h4>Click a camera to enter selfie-mode!</h4>
    <p>TIP: Sometimes camera locations on the map aren't exact: try matching the feed with what you see</p>
</div>
<div class='wrapper'>
<div class='map-class'>
    <div id='map'></div>
</div>
<div class='slider'>
    <div class='slider-title'>
        <div id='location'>
            <p></p>
        </div>
        <button class='slider-toggle'><i class='fa fa-close'></i></button>
    </div>
    <img id='camFeed' src=''>
    <div class='slider-text'>
        <h4>Strike a pose!</h4>
    </div>
    <div class='slider-buttons'>
        <button class='take-selfie'></button>
        <button class='refresh'></button>
    </div>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiamNha2VzMzMiLCJhIjoiY2p4ZGkyb2JyMDExcDNvb2dxZXFuYmY4cSJ9.m21aYnJvrMrnEGEa0AeimQ'
// mapbox map
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-73.985130, 40.758896], // starting position
    zoom: 13,
    scrollZoom: false
});

// slider toggle variables
var toggleBtn = document.querySelector('.slider-toggle');
var sliderCSS = document.querySelector('.slider');
var headerCSS = document.querySelector('.header');
// camera feed variables
var cameraFeed = document.getElementById('camFeed');
var cameraLocation = document.getElementById('location');
var camInterval;
// loading map

map.on('load', () => {
    fetch('https://juliacodessometimes.github.io/selfie_nyc/assets/data.geojson')
    .then(response => response.json())
    .then((data) => {
        map.addSource('source_id', {
            type: 'geojson',
            data: data
        });
        
        if (navigator.geolocation) {
            flyToUser()
        }

        addMarkers();

        function addMarkers() {
            // for each feature in the GeoJSON object above:
            data.features.forEach(function (marker) {
                // create a div element for the marker
                var el = document.createElement('div');
                // assign a unique `id` to the marker
                el.id = 'camera-' + marker.properties.id;
                // assign the `marker` class to each marker for styling
                el.className = 'marker';
                
                // create div element based on above and add to map
                new mapboxgl.Marker(el, { offset: [0, 0] })
                .setLngLat(marker.geometry.coordinates)
                .addTo(map);
                
                el.addEventListener('click', function (e) {
                    // open the slider that holds camera data
                    openSlider(marker);
                    // set the slider html
                    setHTML(marker);
                    // fly to the marker
                    flyToCamera(marker);
                    // getting last-clicked marker location
                    var markerLatLon = marker.geometry.coordinates
                });
            });                
        };
    });
});

// functions
function openSlider() {
    // open slider and hide header
    sliderCSS.classList.add('is-open');
    headerCSS.classList.add('is-open');
}
function setHTML(currentFeature) {
    // load all HTML for slider div

    // set heading text to cross-street
    cameraLocation.innerHTML = currentFeature.properties.name;
    // pre-load camera feed image
    cameraFeed.src = currentFeature.properties.url;
    // clear any previous intervals
    clearInterval(camInterval);

    camInterval = setInterval(function() {
        // set interval that refreshes camera feed image every 1.5 seconds
        cameraFeed.src = currentFeature.properties.url + Math.random();
    }, 1500);
}
function flyToCamera(currentFeature) {
    // fly to current camera marker
    map.flyTo({
        center: currentFeature.geometry.coordinates,
        zoom: 19,
        speed: 1.8,
        offset: [0,-240]
    });
}
function flyFromCamera(markerLatLon) {
    // zoom out from last cliked camera location
    map.flyTo({
        center: markerLatLon,
        zoom: 15,
        speed: 2
    });
}
function flyToUser(userlocation) {
    // fly to user location 
    navigator.geolocation.getCurrentPosition(userlocation => {
        map.flyTo({
            center: [userlocation.coords.longitude, userlocation.coords.latitude],
            zoom: 15
        });
    });
}
toggleBtn.addEventListener('click', function() {
    // close slider functions
    sliderCSS.classList.toggle('is-open');
    headerCSS.classList.toggle('is-open');
    // clear feed interval
    clearInterval(camInterval);
    // zoom out from lat-clicked camera
    flyFromCamera();
});
</script>
</div>
</body>
</html>